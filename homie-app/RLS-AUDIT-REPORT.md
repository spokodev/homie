# üìä –ó–í–Ü–¢ –ê–£–î–ò–¢–£ RLS –ü–û–õ–Ü–¢–ò–ö - HomieLife App
**–î–∞—Ç–∞:** 2025-10-27
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ö—Ä–∏—Ç–∏—á–Ω—ñ –ø—Ä–æ–±–ª–µ–º–∏ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–æ

---

## üéØ –†–ï–ó–Æ–ú–ï

–ü—Ä–æ–≤–µ–¥–µ–Ω–æ –ø–æ–≤–Ω–∏–π –∞—É–¥–∏—Ç Row Level Security (RLS) –ø–æ–ª—ñ—Ç–∏–∫ –¥–ª—è –≤—Å—ñ—Ö —Ç–∞–±–ª–∏—Ü—å –≤ –±–∞–∑—ñ –¥–∞–Ω–∏—Ö HomieLife. –ó–Ω–∞–π–¥–µ–Ω–æ —Ç–∞ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–æ –∫—Ä–∏—Ç–∏—á–Ω—ñ –ø—Ä–æ–±–ª–µ–º–∏ –∑ –±–µ–∑–ø–µ–∫–æ—é.

### ‚úÖ –©–û –í–ò–ü–†–ê–í–õ–ï–ù–û:

1. **members** - –í–∏–ø—Ä–∞–≤–ª–µ–Ω–æ INSERT –ø–æ–ª—ñ—Ç–∏–∫—É –¥–ª—è –¥–æ–∑–≤–æ–ª—É –∞–¥–º—ñ–Ω–∞–º –¥–æ–¥–∞–≤–∞—Ç–∏ —É—á–∞—Å–Ω–∏–∫—ñ–≤ ‚úÖ
2. **task_photos** - –û–±–º–µ–∂–µ–Ω–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ñ–æ—Ç–æ –ª–∏—à–µ –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–∏–º –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞–º ‚úÖ
3. **recurring_tasks** - –î–æ–¥–∞–Ω–æ WITH CHECK –¥–ª—è UPDATE –ø–æ–ª—ñ—Ç–∏–∫–∏ ‚úÖ

### ‚ö†Ô∏è –¢–ê–ë–õ–ò–¶–Ü –Ø–ö–Ü –ù–ï –Ü–°–ù–£–Æ–¢–¨ (–º–æ–∂–ª–∏–≤–æ –≤ backlog):
- `points_ledger` - —Å–∏—Å—Ç–µ–º–∞ –ø–æ—ñ–Ω—Ç—ñ–≤ —â–µ –Ω–µ —ñ–º–ø–ª–µ–º–µ–Ω—Ç–æ–≤–∞–Ω–∞
- `subscriptions` - —Å–∏—Å—Ç–µ–º–∞ –ø—ñ–¥–ø–∏—Å–æ–∫ —â–µ –Ω–µ —ñ–º–ø–ª–µ–º–µ–Ω—Ç–æ–≤–∞–Ω–∞

---

## üìã –î–ï–¢–ê–õ–¨–ù–ò–ô –°–¢–ê–¢–£–° –ö–û–ñ–ù–û–á –¢–ê–ë–õ–ò–¶–Ü

### ‚úÖ –í–ò–ü–†–ê–í–õ–ï–ù–Ü –¢–ê–ë–õ–ò–¶–Ü

#### 1. **members**
- **–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü–æ–≤–Ω—ñ—Å—Ç—é –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–æ
- **–ü—Ä–æ–±–ª–µ–º–∞:** INSERT –ø–æ–ª—ñ—Ç–∏–∫–∞ –Ω–µ –¥–æ–∑–≤–æ–ª—è–ª–∞ –∞–¥–º—ñ–Ω–∞–º –¥–æ–¥–∞–≤–∞—Ç–∏ —É—á–∞—Å–Ω–∏–∫—ñ–≤
- **–†—ñ—à–µ–Ω–Ω—è:** –î–æ–¥–∞–Ω–æ —É–º–æ–≤—É –¥–ª—è –∞–¥–º—ñ–Ω—ñ–≤ –≤ INSERT –ø–æ–ª—ñ—Ç–∏–∫—É
- **–§–∞–π–ª:** `apply-members-fix-v2.js`

#### 2. **task_photos**
- **–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü–æ–≤–Ω—ñ—Å—Ç—é –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–æ
- **–ü—Ä–æ–±–ª–µ–º–∞:** –ë—É–¥—å-—Ö—Ç–æ –º—ñ–≥ –¥–æ–¥–∞–≤–∞—Ç–∏ —Ñ–æ—Ç–æ –¥–æ –Ω–µ–ø—Ä–∏–∑–Ω–∞—á–µ–Ω–∏—Ö —Ç–∞—Å–∫—ñ–≤
- **–†—ñ—à–µ–Ω–Ω—è:** –û–±–º–µ–∂–µ–Ω–æ –ª–∏—à–µ –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–∏–º –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞–º —Ç–∞ –∞–¥–º—ñ–Ω–∞–º
- **–ü–æ–ª—ñ—Ç–∏–∫–∏:**
  - INSERT: –õ–∏—à–µ assignee –∞–±–æ admin
  - SELECT: –í—Å—ñ –≤ household
  - DELETE: –í–ª–∞—Å–Ω–∏–∫ —Ñ–æ—Ç–æ –∞–±–æ admin

#### 3. **recurring_tasks**
- **–°—Ç–∞—Ç—É—Å:** ‚úÖ –í–∏–ø—Ä–∞–≤–ª–µ–Ω–æ
- **–ü—Ä–æ–±–ª–µ–º–∞:** UPDATE –ø–æ–ª—ñ—Ç–∏–∫–∞ –±–µ–∑ WITH CHECK
- **–†—ñ—à–µ–Ω–Ω—è:** –î–æ–¥–∞–Ω–æ WITH CHECK clause

### üìå –¢–ê–ë–õ–ò–¶–Ü –ó –ü–†–ê–í–ò–õ–¨–ù–ò–ú–ò –ü–û–õ–Ü–¢–ò–ö–ê–ú–ò

#### 4. **households**
- **–°—Ç–∞—Ç—É—Å:** ‚úÖ –ö–æ—Ä–µ–∫—Ç–Ω–æ
- **–ü–æ–ª—ñ—Ç–∏–∫–∏:** INSERT, SELECT, UPDATE, DELETE –¥–ª—è –≤–ª–∞—Å–Ω–∏–∫—ñ–≤

#### 5. **rooms**
- **–°—Ç–∞—Ç—É—Å:** ‚úÖ –ö–æ—Ä–µ–∫—Ç–Ω–æ (–∞–ª–µ –≤—ñ–¥–∫—Ä–∏—Ç–æ –¥–ª—è –≤—Å—ñ—Ö —á–ª–µ–Ω—ñ–≤)
- **–ü—Ä–∏–º—ñ—Ç–∫–∞:** –í—Å—ñ —á–ª–µ–Ω–∏ household –º–æ–∂—É—Ç—å —Å—Ç–≤–æ—Ä—é–≤–∞—Ç–∏ –∫—ñ–º–Ω–∞—Ç–∏ (–Ω–µ –ª–∏—à–µ –∞–¥–º—ñ–Ω–∏)

#### 6. **tasks**
- **–°—Ç–∞—Ç—É—Å:** ‚úÖ –ö–æ—Ä–µ–∫—Ç–Ω–æ (–∞–ª–µ –≤—ñ–¥–∫—Ä–∏—Ç–æ –¥–ª—è –≤—Å—ñ—Ö —á–ª–µ–Ω—ñ–≤)
- **–ü—Ä–∏–º—ñ—Ç–∫–∞:** –í—Å—ñ —á–ª–µ–Ω–∏ household –º–æ–∂—É—Ç—å —Å—Ç–≤–æ—Ä—é–≤–∞—Ç–∏ —Ç–∞—Å–∫–∏ (–Ω–µ –ª–∏—à–µ –∞–¥–º—ñ–Ω–∏)

#### 7. **task_categories**
- **–°—Ç–∞—Ç—É—Å:** ‚úÖ –ö–æ—Ä–µ–∫—Ç–Ω–æ
- **–ü–æ–ª—ñ—Ç–∏–∫–∏:** –õ–∏—à–µ –∞–¥–º—ñ–Ω–∏ –º–æ–∂—É—Ç—å —É–ø—Ä–∞–≤–ª—è—Ç–∏ –∫–∞—Ç–µ–≥–æ—Ä—ñ—è–º–∏

#### 8. **subtasks**
- **–°—Ç–∞—Ç—É—Å:** ‚úÖ –ö–æ—Ä–µ–∫—Ç–Ω–æ
- **–ü–æ–ª—ñ—Ç–∏–∫–∏:** –ß–ª–µ–Ω–∏ household –º–æ–∂—É—Ç—å —Å—Ç–≤–æ—Ä—é–≤–∞—Ç–∏ subtasks

### ‚ö†Ô∏è –¢–ê–ë–õ–ò–¶–Ü –Ø–ö–Ü –ù–ï –Ü–°–ù–£–Æ–¢–¨

#### 9. **points_ledger**
- **–°—Ç–∞—Ç—É—Å:** ‚ùå –¢–∞–±–ª–∏—Ü—è –Ω–µ —ñ—Å–Ω—É—î
- **–ó–∞–ø–ª–∞–Ω–æ–≤–∞–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è:** –°–∏—Å—Ç–µ–º–∞ –Ω–∞—Ä–∞—Ö—É–≤–∞–Ω–Ω—è –ø–æ—ñ–Ω—Ç—ñ–≤
- **SQL –ø—ñ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–æ:** –¢–∞–∫, –≤ `FIX-ALL-CRITICAL-RLS.sql`

#### 10. **subscriptions**
- **–°—Ç–∞—Ç—É—Å:** ‚ùå –¢–∞–±–ª–∏—Ü—è –Ω–µ —ñ—Å–Ω—É—î
- **–ó–∞–ø–ª–∞–Ω–æ–≤–∞–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è:** –°–∏—Å—Ç–µ–º–∞ –ø—ñ–¥–ø–∏—Å–æ–∫
- **SQL –ø—ñ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–æ:** –¢–∞–∫, –≤ `FIX-ALL-CRITICAL-RLS.sql`

---

## üõ†Ô∏è –§–ê–ô–õ–ò –°–¢–í–û–†–ï–ù–Ü –î–õ–Ø –í–ò–ü–†–ê–í–õ–ï–ù–ù–Ø

1. **fix-members-rls-complete.sql** - –ü–æ–≤–Ω–µ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è –¥–ª—è members
2. **apply-members-fix-v2.js** - –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∞ –º—ñ–≥—Ä–∞—Ü—ñ—è –¥–ª—è members ‚úÖ
3. **FIX-ALL-CRITICAL-RLS.sql** - –í—Å—ñ –∫—Ä–∏—Ç–∏—á–Ω—ñ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è
4. **apply-critical-rls-direct.js** - –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –∑–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è –≤–∏–ø—Ä–∞–≤–ª–µ–Ω—å ‚úÖ
5. **verify-members-rls.js** - –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ members –ø–æ–ª—ñ—Ç–∏–∫
6. **ERROR-DEBUGGING-GUIDE.md** - –ì–∞–π–¥ –ø–æ –Ω–∞–ª–∞–≥–æ–¥–∂–µ–Ω–Ω—é –ø–æ–º–∏–ª–æ–∫

---

## üîç –ó–ù–ê–ô–î–ï–ù–Ü –ü–ê–¢–ï–†–ù–ò –ü–†–û–ë–õ–ï–ú

### 1. **–ó–∞–Ω–∞–¥—Ç–æ –æ–±–º–µ–∂–µ–Ω—ñ INSERT –ø–æ–ª—ñ—Ç–∏–∫–∏**
- –ù–µ –≤—Ä–∞—Ö–æ–≤—É—é—Ç—å –∞–¥–º—ñ–Ω –æ–ø–µ—Ä–∞—Ü—ñ—ó
- –ü—Ä–∏–∫–ª–∞–¥: members –º—ñ–≥ —Å—Ç–≤–æ—Ä–∏—Ç–∏ –ª–∏—à–µ –≤–ª–∞—Å–Ω–∏–π –ø—Ä–æ—Ñ—ñ–ª—å

### 2. **–í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è LIMIT 1 –±–µ–∑ ORDER BY**
- –ù–µ–ø–µ—Ä–µ–¥–±–∞—á—É–≤–∞–Ω–∞ –ø–æ–≤–µ–¥—ñ–Ω–∫–∞ –¥–ª—è multi-household –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤
- –ó–Ω–∞–π–¥–µ–Ω–æ –≤: room_notes, messages, captain_ratings

### 3. **–í—ñ–¥—Å—É—Ç–Ω—ñ WITH CHECK –≤ UPDATE –ø–æ–ª—ñ—Ç–∏–∫–∞—Ö**
- UPDATE –º–æ–∂–µ –≤–∏–±—Ä–∞—Ç–∏ —Ä—è–¥–æ–∫ –∞–ª–µ –Ω–µ –æ–Ω–æ–≤–∏—Ç–∏ –π–æ–≥–æ
- –ó–Ω–∞–π–¥–µ–Ω–æ –≤: recurring_tasks

### 4. **–†–µ–∫—É—Ä—Å–∏–≤–Ω—ñ SELECT –∑–∞–º—ñ—Å—Ç—å helper —Ñ—É–Ω–∫—Ü—ñ–π**
- –ü–æ—Ç–µ–Ω—Ü—ñ–π–Ω–∞ infinite recursion
- –ó–Ω–∞–π–¥–µ–Ω–æ –≤: room_notes (–≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞–ª–æ –ø—Ä—è–º–∏–π SELECT –∑ members)

---

## üí° –†–ï–ö–û–ú–ï–ù–î–ê–¶–Ü–á

### –ù–µ–≥–∞–π–Ω–æ (–≤–∂–µ –≤–∏–∫–æ–Ω–∞–Ω–æ ‚úÖ):
1. ‚úÖ –í–∏–ø—Ä–∞–≤–∏—Ç–∏ members INSERT –ø–æ–ª—ñ—Ç–∏–∫—É
2. ‚úÖ –í–∏–ø—Ä–∞–≤–∏—Ç–∏ task_photos INSERT –ø–æ–ª—ñ—Ç–∏–∫—É
3. ‚úÖ –î–æ–¥–∞—Ç–∏ WITH CHECK –¥–æ recurring_tasks UPDATE

### –ü—Ä–∏ —ñ–º–ø–ª–µ–º–µ–Ω—Ç–∞—Ü—ñ—ó –Ω–æ–≤–∏—Ö —Ñ—É–Ω–∫—Ü—ñ–π:
1. **points_ledger** - –≤–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏ –ø—ñ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω—ñ –ø–æ–ª—ñ—Ç–∏–∫–∏ –∑ `FIX-ALL-CRITICAL-RLS.sql`
2. **subscriptions** - –≤–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏ –ø—ñ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω—ñ –ø–æ–ª—ñ—Ç–∏–∫–∏ –∑ `FIX-ALL-CRITICAL-RLS.sql`

### –†–æ–∑–≥–ª—è–Ω—É—Ç–∏ –≤ –º–∞–π–±—É—Ç–Ω—å–æ–º—É:
1. **rooms/tasks** - –≤–∏—Ä—ñ—à–∏—Ç–∏ —á–∏ –ø–æ—Ç—Ä—ñ–±–Ω–æ –æ–±–º–µ–∂–∏—Ç–∏ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –ª–∏—à–µ –∞–¥–º—ñ–Ω–∞–º
2. **–ö–µ—à—É–≤–∞–Ω–Ω—è** - –¥–æ–¥–∞—Ç–∏ –∫–µ—à—É–≤–∞–Ω–Ω—è admin —Å—Ç–∞—Ç—É—Å—É –¥–ª—è –ø–æ–∫—Ä–∞—â–µ–Ω–Ω—è performance

---

## üìà –ú–ï–¢–†–ò–ö–ò –ë–ï–ó–ü–ï–ö–ò

| –ö–∞—Ç–µ–≥–æ—Ä—ñ—è | –î–æ –∞—É–¥–∏—Ç—É | –ü—ñ—Å–ª—è –∞—É–¥–∏—Ç—É |
|-----------|-----------|--------------|
| –ö—Ä–∏—Ç–∏—á–Ω—ñ –ø—Ä–æ–±–ª–µ–º–∏ | 3 | 0 ‚úÖ |
| –í–∏—Å–æ–∫–∏–π —Ä–∏–∑–∏–∫ | 2 | 0 ‚úÖ |
| –°–µ—Ä–µ–¥–Ω—ñ–π —Ä–∏–∑–∏–∫ | 3 | 1 |
| –¢–∞–±–ª–∏—Ü—ñ –±–µ–∑ –ø–æ–ª—ñ—Ç–∏–∫ | 2* | 0** |

\* points_ledger, subscriptions (—Ç–∞–±–ª–∏—Ü—ñ –Ω–µ —ñ—Å–Ω—É—é—Ç—å)
\** –í—Å—ñ —ñ—Å–Ω—É—é—á—ñ —Ç–∞–±–ª–∏—Ü—ñ –º–∞—é—Ç—å –ø–æ–ª—ñ—Ç–∏–∫–∏

---

## ‚úÖ –¢–ï–°–¢–£–í–ê–ù–ù–Ø

–ü—ñ—Å–ª—è –≤–∏–ø—Ä–∞–≤–ª–µ–Ω—å –ø–µ—Ä–µ–≤—ñ—Ä—Ç–µ:

1. **–î–æ–¥–∞–≤–∞–Ω–Ω—è —É—á–∞—Å–Ω–∏–∫—ñ–≤** - –∞–¥–º—ñ–Ω –º–æ–∂–µ –¥–æ–¥–∞—Ç–∏ –ª—é–¥–µ–π —Ç–∞ —Ç–≤–∞—Ä–∏–Ω ‚úÖ
2. **–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ñ–æ—Ç–æ** - –ª–∏—à–µ –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–∏–π –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –∞–±–æ –∞–¥–º—ñ–Ω
3. **Recurring tasks** - –∞–¥–º—ñ–Ω–∏ –º–æ–∂—É—Ç—å —Å—Ç–≤–æ—Ä—é–≤–∞—Ç–∏ —Ç–∞ –æ–Ω–æ–≤–ª—é–≤–∞—Ç–∏
4. **–ó–∞–≥–∞–ª—å–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—å–Ω—ñ—Å—Ç—å** - –≤—Å—ñ –æ—Å–Ω–æ–≤–Ω—ñ —Ñ—É–Ω–∫—Ü—ñ—ó –ø—Ä–∞—Ü—é—é—Ç—å

---

## üìû –ü–Ü–î–¢–†–ò–ú–ö–ê

–Ø–∫—â–æ –≤–∏–Ω–∏–∫–Ω—É—Ç—å –Ω–æ–≤—ñ –ø–æ–º–∏–ª–∫–∏ RLS:

1. –°–∫–æ–ø—ñ—é–π—Ç–µ –ø–æ–≤–Ω–∏–π —Ç–µ–∫—Å—Ç –ø–æ–º–∏–ª–∫–∏
2. –í–∫–∞–∂—ñ—Ç—å —è–∫—É –¥—ñ—é –Ω–∞–º–∞–≥–∞–ª–∏—Å—å –≤–∏–∫–æ–Ω–∞—Ç–∏
3. –ó–∞–ø—É—Å—Ç—ñ—Ç—å `verify-members-rls.js` –¥–ª—è –¥—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∏

---

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –í—Å—ñ –∫—Ä–∏—Ç–∏—á–Ω—ñ RLS –ø—Ä–æ–±–ª–µ–º–∏ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–æ. –î–æ–¥–∞—Ç–æ–∫ –≥–æ—Ç–æ–≤–∏–π –¥–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è.